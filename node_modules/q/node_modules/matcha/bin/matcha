#!/usr/bin/env node
// -*- mode: javascript -*-
// vi: set ft=javascript :

var electron = require('electron')
  , matcha = require('..');

var Interface = require('../lib/matcha/interface');

var program = electron('matcha')
  .name('Matcha')
  .version(matcha.version)
  .desc('https://github.com/logicalparadox/matcha')
  .cwd(process.cwd())
  .theme('simple', {
      command: 'absent'
    , usage: '<options> <files>'
  });

program
  .command('absent')
  .desc('Run a suite of benchmarks.')
  .option('-h, --help', 'view matcha usage information')
  .option('-v, --version', 'view matcha version')
  .option('-R, --reporter [default]', 'specify the reporter to use')
  .option('-I, --interface [bdd]', 'specify the interface to expect')
  .action(runSuite);

program
  .command('default')
  .action(runSuite);

program.parse();

function runSuite (argv) {
  var showReporters = argv.mode('reporters');

  if (showReporters) {
    program.colorize();
    console.log('show reporters'.green);
    process.exit();
  }

  var path = require('path')
    , fs = require('fs')
    , cwd = argv.cwd
    , files = argv.commands.slice(0)
    , re = /\.js$/;

  if (!files.length) {
    files = fs.readdirSync('benchmark').filter(function(path){
      return path.match(re);
    }).map(function(_p){
      return path.join('benchmark', _p);
    });
  }

  files = files.map(function(_p){
    _p = require.resolve(path.join(cwd, _p));
    return _p;
  });

  var style = argv.param('I', 'interface') || 'bdd'
    , suite = new matcha.Suite()
    , ui = new Interface(suite, { style: style });

  load(files, function () {
    run(suite, process.exit);
  });

  function load (files, cb) {
    var after = files.length
    files.forEach(function (file) {
      delete require.cache[file];
      suite.emit('pre-require');
      suite.emit('require', require(file));
      --after || cb();
    });
  }

  function run (suite, cb) {
    var runner = new matcha.Runner(suite)
      , reporter = new matcha.reporters.Clean(runner);
    runner.run(cb);
  }

};

